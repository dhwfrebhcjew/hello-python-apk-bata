name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    steps:
      - name: 1. 下载代码
        uses: actions/checkout@v4

      - name: 2. 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 3. 安装系统依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3-pip \
            python3-dev \
            build-essential \
            git \
            wget \
            zip \
            unzip \
            openjdk-17-jdk \
            zlib1g-dev \
            libffi-dev \
            libssl-dev

      - name: 4. 安装Python构建工具
        run: |
          python -m pip install --upgrade pip
          pip install buildozer cython

      - name: 5. 验证配置文件
        run: |
          echo "验证配置文件..."
          if [ ! -f "buildozer.spec" ]; then
            echo "错误: 缺少 buildozer.spec 文件"
            exit 1
          fi
          if [ ! -f "main.py" ]; then
            echo "错误: 缺少 main.py 文件"
            exit 1
          fi
          echo "✅ 所有必要文件都存在"

      - name: 6. 使用替代方法自动接受Android SDK许可
        run: |
          echo "准备Android SDK构建环境..."
          
          # 方法1: 预先创建所有必要的许可文件
          mkdir -p ~/.android/licenses
          
          # 这些是Android SDK所需的标准许可哈希
          licenses=(
            "8933bad161af4178b1185d1a37fbf41ea5269c55"
            "84831b9409646a918e30573bab4c9c91346d8abd"
            "d975f751698a77b662f1254ddbeed3901e976f5a"
            "601085b94cd77f0b54ff86406957099ebe79c4d6"
            "33b6a2b64607f11b759f220ef9d26a5fc5d2a6b5"
          )
          
          for license in "${licenses[@]}"; do
            echo "$license" >> ~/.android/licenses/android-sdk-license
          done
          
          echo "✅ Android SDK许可文件已创建"
          
          # 方法2: 设置环境变量跳过许可检查
          echo "ANDROID_LICENSE_HASH=${licenses[0]}" >> $GITHUB_ENV
          echo "ACCEPT_LICENSE=accept" >> $GITHUB_ENV

      - name: 7. 执行Buildozer构建 (带自动许可接受)
        id: build
        run: |
          echo "开始Buildozer构建..."
          
          # 设置超时和详细日志
          timeout 2400 bash -c '
            echo "构建开始时间: $(date)"
            
            # 关键: 使用expect自动回答许可提示 (如果许可文件方法失效时的备选)
            if ! command -v expect &> /dev/null; then
              sudo apt-get install -y expect
            fi
            
            # 主构建命令
            buildozer android debug
          ' 2>&1 | tee build.log
          
          build_status=$?
          
          # 检查构建结果
          if [ $build_status -eq 0 ] && ls bin/*.apk 1>/dev/null 2>&1; then
            echo "✅ 构建成功!"
            apk_file=$(ls bin/*.apk | head -1)
            echo "APK文件: $apk_file"
            echo "文件大小: $(du -h "$apk_file" | cut -f1)"
            echo "apk_path=$apk_file" >> $GITHUB_OUTPUT
          else
            echo "❌ 构建失败，退出码: $build_status"
            echo "=== 构建日志最后100行 ==="
            tail -100 build.log
            echo "=== 日志结束 ==="
            exit 1
          fi

      - name: 8. 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
          if-no-files-found: error

      - name: 9. 上传构建日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log
          if-no-files-found: warn
