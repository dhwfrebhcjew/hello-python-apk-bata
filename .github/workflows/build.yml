name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 设置超时时间
    
    steps:
    - name: 1. 下载代码
      uses: actions/checkout@v4
    
    - name: 2. 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: 3. 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          wget \
          zip \
          unzip \
          openjdk-17-jdk \
          libncurses5 \
          libstdc++6 \
          zlib1g-dev \
          libffi-dev \
          libssl-dev
    
    - name: 4. 安装Buildozer和依赖
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --no-cache-dir buildozer cython==0.29.33
    
    - name: 5. 显示环境信息
      run: |
        echo "Python版本: $(python --version)"
        echo "Buildozer版本: $(buildozer --version 2>/dev/null || echo '未安装')"
        echo "Java版本: $(java -version 2>&1 | head -1)"
    
    - name: 6. 准备构建环境
      run: |
        # 创建日志文件
        touch build_output.log
        echo "环境准备完成" >> build_output.log
        
        # 确保bin目录存在
        mkdir -p bin
        
        # 显示当前目录结构
        echo "当前目录结构:"
        ls -la
    
    - name: 7. 开始构建APK（关键修复步骤）
      id: build-apk
      run: |
        echo "=== 开始构建APK ==="
        
        # 使用timeout防止无限挂起，并保存完整日志
        timeout 2400 buildozer android debug 2>&1 | tee -a build_output.log
        
        BUILD_STATUS=${PIPESTATUS[0]}
        
        echo "=== 构建过程结束，退出代码: $BUILD_STATUS ==="
        
        # 检查APK是否生成
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ SUCCESS: APK构建成功！"
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "生成的APK: $APK_FILE"
          echo "文件大小: $(du -h "$APK_FILE" | cut -f1)"
          echo "::set-output name=apk_path::$APK_FILE"
          exit 0
        else
          echo "❌ FAILURE: 未找到APK文件"
          echo "=== 开始输出构建日志（最后200行）==="
          tail -200 build_output.log
          echo "=== 构建日志输出结束 ==="
          
          # 如果是超时，提供特定错误信息
          if [ $BUILD_STATUS -eq 124 ]; then
            echo "错误: 构建超时（超过40分钟）"
            echo "建议: 1. 检查buildozer.spec配置 2. 减少requirements中的包"
          fi
          
          exit 1
        fi
    
    - name: 8. 上传构建日志
      if: always()  # 无论成功失败都上传日志
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build_output.log
        if-no-files-found: warn
        retention-days: 7
    
    - name: 9. 上传APK文件
      if: success()  # 只有构建成功时才上传APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30
    
    - name: 10. 构建失败时的额外诊断
      if: failure()
      run: |
        echo "=== 构建失败诊断信息 ==="
        echo "检查buildozer.spec文件:"
        if [ -f "buildozer.spec" ]; then
          echo "文件存在，内容预览:"
          head -50 buildozer.spec
        else
          echo "错误: 找不到buildozer.spec文件"
        fi
        
        echo "检查main.py文件:"
        if [ -f "main.py" ]; then
          echo "文件存在，大小: $(wc -l < main.py) 行"
        else
          echo "错误: 找不到main.py文件"
        fi
        
        echo "检查.buildozer目录:"
        if [ -d ".buildozer" ]; then
          echo "目录存在，内容:"
          ls -la .buildozer/
        fi
