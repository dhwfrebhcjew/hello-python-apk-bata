name: Build Android APK

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    steps:
      - name: 1. 下载代码
        uses: actions/checkout@v4

      - name: 2. 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: 3. 安装系统依赖
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            python3-pip \
            python3-dev \
            build-essential \
            git \
            wget \
            zip \
            unzip \
            openjdk-17-jdk \
            zlib1g-dev \
            libffi-dev \
            libssl-dev \
            expect

      - name: 4. 安装Python构建工具
        run: |
          python -m pip install --upgrade pip
          pip install buildozer cython==0.29.33

      - name: 5. 验证配置文件
        run: |
          echo "验证配置文件..."
          if [ ! -f "buildozer.spec" ]; then
            echo "错误: 缺少 buildozer.spec 文件"
            exit 1
          fi
          if [ ! -f "main.py" ]; then
            echo "错误: 缺少 main.py 文件"
            exit 1
          fi
          echo "✅ 所有必要文件都存在"

      - name: 6. 准备自动接受Android SDK许可
        run: |
          echo "准备自动接受Android SDK许可..."
          
          # 创建简单的expect脚本
          cat > accept_licenses.sh << 'EOF'
#!/bin/bash
# 这个脚本会自动接受Android SDK许可
echo "设置Android SDK许可自动接受..."

# 创建许可目录
mkdir -p ~/.android/licenses

# 写入标准许可哈希
echo -e "8933bad161af4178b1185d1a37fbf41ea5269c55\n84831b9409646a918e30573bab4c9c91346d8abd\nd975f751698a77b662f1254ddbeed3901e976f5a" > ~/.android/licenses/android-sdk-license

# 设置环境变量
export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
export ANDROID_HOME="$ANDROID_SDK_ROOT"
export SDKMANAGER_OPTS="--sdk_root=$ANDROID_SDK_ROOT"

echo "✅ 许可设置完成"
EOF
          
          chmod +x accept_licenses.sh

      - name: 7. 执行Buildozer构建（简化版）
        id: build
        run: |
          echo "=== 开始Buildozer构建 ==="
          
          # 运行许可接受脚本
          ./accept_licenses.sh
          
          echo "开始主构建过程..."
          
          # 使用简单的构建命令，避免复杂嵌套
          buildozer android debug 2>&1 | tee build.log
          
          build_status=${PIPESTATUS[0]}
          
          echo "=== Buildozer退出码: $build_status ==="
          
          # 检查APK是否生成
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "✅ 构建成功!"
            apk_file=$(ls bin/*.apk | head -1)
            echo "APK文件: $apk_file"
            echo "文件大小: $(du -h "$apk_file" | cut -f1)"
            echo "apk_path=$apk_file" >> $GITHUB_OUTPUT
          else
            echo "❌ 构建失败"
            echo "=== 最后100行日志 ==="
            tail -100 build.log
            echo "=== 关键错误信息 ==="
            grep -i -B2 -A2 "error\|fail\|not found\|accept\|license" build.log | head -50
            exit 1
          fi

      - name: 8. 上传APK文件
        if: success() && steps.build.outputs.apk_path
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
          if-no-files-found: error

      - name: 9. 上传构建日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log
          if-no-files-found: warn
