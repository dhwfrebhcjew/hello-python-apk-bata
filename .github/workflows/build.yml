name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 设置超时时间
    
    steps:
    - name: 1. 下载代码
      uses: actions/checkout@v4
    
    - name: 2. 设置Python环境
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: 3. 安装系统依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3-pip \
          build-essential \
          git \
          wget \
          curl \
          zip \
          unzip \
          openjdk-17-jdk \
          libncurses5 \
          libstdc++6 \
          zlib1g-dev \
          libffi-dev \
          libssl-dev \
          libltdl-dev \
          libgl1-mesa-dev \
          libgles2-mesa-dev
    
    - name: 4. 安装Buildozer和依赖
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install --no-cache-dir buildozer cython==0.29.33 virtualenv
    
    - name: 5. 显示环境信息
      run: |
        echo "Python版本: $(python --version)"
        echo "Buildozer版本: $(buildozer --version 2>/dev/null || echo '检查中...')"
        echo "Java版本: $(java -version 2>&1 | head -1)"
    
    - name: 6. 初始化Buildozer配置（如果不存在）
      run: |
        if [ ! -f "buildozer.spec" ]; then
          echo "未找到buildozer.spec，正在创建默认配置..."
          buildozer init
          # 修改默认配置
          sed -i 's/^title = My Application/title = Hello Python APK/' buildozer.spec
          sed -i 's/^package.name = myapp/package.name = hellopythonapk/' buildozer.spec
          sed -i 's/^requirements = python3,kivy/requirements = python3,kivy==2.1.0/' buildozer.spec
          sed -i 's/^android.arch = armeabi-v7a/android.arch = arm64-v8a/' buildozer.spec
        fi
    
    - name: 7. 清理之前的构建
      run: |
        rm -rf .buildozer/.gradle/
        rm -rf .buildozer/android/platform/build-*/ || true
    
    - name: 8. 开始构建APK
      id: build-apk
      run: |
        echo "开始构建APK，这可能需要30-40分钟..."
        echo "=================================="
        
        # 设置环境变量加速下载
        export BUILD_MEMORY="4G"
        export GRADLE_OPTS="-Xmx4096m -Dorg.gradle.daemon=false"
        
        # 运行Buildozer并保存日志
        timeout 2400 buildozer android debug 2>&1 | tee build_output.log
        
        # 检查构建结果
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK构建成功！"
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "APK文件: $APK_FILE"
          echo "文件大小: $(du -h "$APK_FILE" | cut -f1)"
          echo "::set-output name=apk_path::$APK_FILE"
        else
          echo "❌ APK构建失败！"
          echo "最后的构建输出:"
          tail -100 build_output.log
          exit 1
        fi
    
    - name: 9. 上传构建日志
      if: always()  # 无论成功失败都上传日志
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build_output.log
          .buildozer/android/platform/*/build/outputs/**/*.log
        if-no-files-found: warn
        retention-days: 7
    
    - name: 10. 上传APK文件
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        if-no-files-found: error
        retention-days: 30
