name: Android CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          python3-venv \
          build-essential \
          libffi-dev \
          libssl-dev \
          expect
    
    - name: Install Buildozer
      run: |
        pip install --upgrade pip
        pip install buildozer cython
    
    - name: Setup Android SDK
      run: |
        mkdir -p ~/.android
        touch ~/.android/repositories.cfg
        
        # 设置环境变量
        echo "ANDROID_SDK_ROOT=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=$HOME/.buildozer/android/platform/android-sdk" >> $GITHUB_ENV
    
    - name: Configure Buildozer
      run: |
        if [ ! -f "buildozer.spec" ]; then
          buildozer init
        fi
        
        # 更新 buildozer.spec 配置
        cat >> buildozer.spec << 'EOF'

# CI/CD 配置
android.accept_license = yes
android.sdk = 34
android.ndk = 25b
android.api = 34
android.minapi = 21

# 构建优化
android.verbose = true
android.ignore_version_check = yes
EOF
    
    - name: Accept Android Licenses
      run: |
        # 创建一个自动接受许可证的脚本
        cat > accept_licenses.sh << 'EOF'
#!/bin/bash
set -e

# 等待 SDK 管理器可用
MAX_WAIT=300
WAIT_COUNT=0
while [ ! -f ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager ] && [ $WAIT_COUNT -lt $MAX_WAIT ]; do
  sleep 10
  WAIT_COUNT=$((WAIT_COUNT + 10))
  echo "等待 SDK 管理器... ($WAIT_COUNT/$MAX_WAIT 秒)"
done

if [ -f ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager ]; then
  echo "接受 Android SDK 许可证..."
  
  # 使用 expect 自动交互
  expect << 'SCRIPT'
set timeout 300
spawn ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager --licenses
expect {
  "Accept? (y/N):" { send "y\r"; exp_continue }
  "Review licenses" { send "y\r"; exp_continue }
  eof
}
SCRIPT

  echo "许可证接受完成"
else
  echo "警告: SDK 管理器未找到"
fi
EOF
        
        chmod +x accept_licenses.sh
        
        # 提前运行 buildozer 来下载 SDK，然后在后台接受许可证
        timeout 60 buildozer android clean || true &
        sleep 30
        
        # 运行许可证接受脚本
        ./accept_licenses.sh || true
    
    - name: Build APK
      run: |
        # 设置环境
        export ANDROID_HOME="$HOME/.buildozer/android/platform/android-sdk"
        export ANDROID_SDK_ROOT="$ANDROID_HOME"
        
        # 使用详细的构建
        echo "开始构建 APK..."
        buildozer -v android debug
        
        # 检查构建结果
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ 构建成功!"
          ls -lh bin/*.apk
        else
          echo "❌ 构建失败"
          # 显示错误信息
          find .buildozer -name "*.log" -exec tail -50 {} \; || true
          exit 1
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
